## 一、实验背景

在最小操作系统实验中，我们已经实现了内核启动与串口输出 `"helloos"`。
 为了进一步支持 **格式化输出与终端控制**，本实验实现了一个简化版的 `printf`，并扩展了清屏、光标定位、颜色输出等功能。

该实验参考了 **xv6 的 `printf.c` 实现方法**，采用分层设计，将串口驱动、控制台封装与格式化输出分离，实现了一个可扩展、可维护的输出子系统。

------

## 二、设计目标

1. **基础输出功能**：支持 `printf("%d %x %s %c")` 等常见格式符。
2. **终端控制功能**：支持清屏、清行、光标定位、彩色输出。
3. **分层设计**：驱动、控制台、printf 独立，便于移植和扩展。
4. **教学简化**：无缓冲区、无锁机制，单核单线程环境下可用。

------

## 三、整体架构

输出子系统分为三层：

1. **UART 驱动层 (`uart.c`)**
   - 直接与硬件寄存器交互。
   - 提供 `uartinit()`、`uartputc()`、`uartputs()`。
2. **Console 层 (`console.c`)**
   - 基于 UART 驱动，提供更高级的字符输出接口。
   - 负责 `consputc()`（换行兼容）、清屏 `clear()`、光标移动 `goto_xy()`、清行 `clear_line()`。
3. **格式化输出层 (`printf.c`)**
   - 实现 `printf()`、`vprintf()`、`printint()`。
   - 支持 `%d`、`%x`、`%s`、`%c`、`%%`。
   - 扩展支持彩色输出 `printf_color()`。

调用关系：
 `printf()` → `vprintf()` → `consputc()` → `uartputc()` → **UART 寄存器**

------

## 四、主要实现方法

1. **数字输出 (`printint`)**
   - 使用除基取余法，将整数逐位写入临时缓冲，再逆序输出。
   - 避免使用递归，防止栈溢出。
   - 负数通过转为正数输出，附加 `-` 号。
   - 注意：`INT_MIN` 可能溢出，需用无符号数处理。
2. **格式化解析 (`vprintf`)**
   - 逐字符扫描 `fmt`，遇到 `%` 后根据格式符取参数并输出。
   - 普通字符直接 `consputc()`。
   - 不支持宽度/精度，仅支持最常用的格式。
3. **终端控制**
   - 清屏：`\033[3J\033[2J\033[H`（清除滚动缓冲、可见区并光标复位）。
   - 清行：`\033[2K\r`。
   - 光标定位：`\033[y;xH`。
   - 彩色输出：`\033[%dm ... \033[0m`。

------

## 五、使用方法

### 1. 编译与运行

```
make qemu
```

### 2. 示例代码

```
void main(void) {
    consoleinit();

    printf("Hello, %s!\n", "OS");
    printf("Number: %d, Hex: %x\n", 123, 0xABCD);

    printf_color(31, "This is red text: %d\n", -456);

    clear();
    goto_xy(5, 10);
    printf("Cursor moved here\n");

    clear_line();
    printf("Line cleared and replaced\n");

    while (1) {}
}
```

### 3. 运行效果

- 支持基本格式化输出。
- 支持彩色、光标定位、清屏/清行等操作。
- 在 QEMU `-nographic` 模式下可直接观察输出。

------

## 六、设计思考与总结

- **是否需要缓冲区？**
   当前实现直接同步输出，不需要缓冲。但效率低，未来可用环形缓冲+中断优化。
- **格式错误如何处理？**
   未知格式符原样输出 `%x`。
- **为什么不用递归？**
   避免栈溢出，内核栈空间有限。
- **负数转为正数处理的意义？**
   避免直接操作 `INT_MIN` 溢出问题，统一正数输出逻辑。
- **分层设计的优势？**
   硬件无关性强，只需修改 console 层即可迁移到 VGA 或其他输出设备。